!----------------- Input deck illustrating the Python-Fortran interface ------------------
! To run this input deck as is, first put the input deck, OSIRIS executable, and the
! py-script-{{ dims }}d.py file all in the same directory.  Next, do `export PYTHONPATH=.` to set the Python
! path to the directory that contains the py-script-{{ dims }}d.py file (current directory). Finally,
! execute `./osiris-{{ dims }}D.e {{ inputfile_name }}` to run the simulation, which will use the
! py-script-{{ dims }}d.py and interp.npy files to set various field and particle data.
!-----------------------------------------------------------------------------------------

!----------global simulation parameters----------
simulation 
{
    parallel_io = "mpi",
    algorithm = "{{ algorithm }}",
}

!--------the node configuration for this simulation--------
node_conf 
{
    {% if dims == 1 %}
    {% if algorithm == "cuda" %}
    node_number = 2,
    n_threads = 1,
    {% else %}
    node_number = 16,
    n_threads = 2,
    {% endif %}
    if_periodic(1:1) = .false.,
    {% else %}
    {% if algorithm == "cuda" %}
    node_number = 2, 1,
    n_threads = 1,
    {% else %}
    node_number = 16, 1,
    n_threads = 2,
    {% endif %}
    if_periodic(1:2) = .true., .false.,
    {% endif %}
    {% if algorithm in ["cuda", "tiles"] %}
    {% if dims ==1 %}tile_number(1:1) = {{ tile_numbers[0] }},{% else %}
    tile_number(1:{{ dims }}) = {{ tile_numbers|join(', ') }},{% endif %} {% endif %}
}

!----------spatial grid----------
grid
{
    {% if dims == 1 %}nx_p = {{ nx }},{% else %}
    nx_p(1:2) = {{ nx }}, {{ ny }},{% endif %}
}

!----------time step and global data dump timestep number----------
time_step
{
    dt     =  {{ dt }},
    ndump  =  {{ ndump }},
}

!----------restart information----------
restart
{
    ndump_fac = -1,
    ndump_time = 3500, !once/hour
    if_restart = .false.,
    if_remold = .true.,
}

!----------spatial limits of the simulations----------
space
{
    {% if dims == 1 %}! This is euclidean distance, not the span in y direction
    ! Start point in {{ dims }}D plane is specified in py-script-{{ dims }}d
    xmin =  0, ! This should always be == 0
    xmax =  {{ xmax }},
    {% else %}
    xmin(1:2) = {{ xmin }}, {{ ymin }},
    xmax(1:2) = {{ xmax }}, {{ ymax }},
    {% endif %}
}

!----------time limits ----------
time
{
    tmin = 0.0,
    tmax  = {{ tmax }},
}

!----------field solver set up----------
el_mag_fld
{
    ! Note, you need to set PYTHONPATH in the console to the folder containing py-script-{{ dims }}d.py
    type_init_b(1:3) = "python", "python", "python",
    type_init_e(1:3) = "python", "python", "python",
    init_py_mod = "py-script-{{ dims }}d", ! Name of Python file
    init_py_func = "set_fld_int", ! Name of function in the Python file to call (same for all components)
}

!----------boundary conditions for em-fields ----------
emf_bound
{
    {% if dims == 1 %}
    type(1:2,1) =   "pmc", "vpml",
    vpml_bnd_size = {{ vpml_bnd_size }},
    vpml_diffuse(1:2,1) = .true., .true.,
    {% else %}
    type(1:2,2) =  "pmc", "vpml", ! boundaries for x2
    vpml_diffuse(2,2) = .true.,
    vpml_bnd_size = 100,
    {% endif %}
}

!----------- electro-magnetic field diagnostics ---------
diag_emf
{
    reports = 
    "b1, savg",
    "b2, savg",
    "b3, savg",
    "e1, savg",
    "e2, savg",
    "e3, savg",

    ndump_fac_ave = 1,
    ndump_fac_ene_int = 10,
    ndump_fac_charge_cons = 10,
    {% if dims == 1 %}
    n_ave(1:1) = 4,
    {% else %}
    n_ave(1:2) = 4, 4,
    {% endif %}
}

!----------number of particle species----------
particles
{
    interpolation = "{{ interpolation }}",
    num_species = {{ species_list|length }},
}

{% for species in species_list %}
!----------information for {{ species['name'] }}----------
species
{
    name = "{{ species['name'] }}",
    rqm = {{ species['rqm'] }},
    {% if dims == 1 %}
    num_par_x = {{ ppc }},
    {% else %}
    num_par_x(1:2) = {{ ppc|int }}, {{ ppc|int }},
    {% endif %}
    init_type = "python",
}

!----------inital proper velocities - {{ species['name'] }}-----------------
udist
{
    use_spatial_uth = .true.,
    uth_py_mod = "py-script-{{ dims }}d", ! Name of Python file
    uth_py_func = "set_uth_{{ species['name'] }}", ! Name of function in the Python file to call

    ! use_spatial_ufl = .true.,
    ufl_py_mod = "py-script-{{ dims }}d", ! Name of Python file
    ufl_py_func = "set_ufl_{{ species['name'] }}", ! Name of function in the Python file to call
}

!----------density profile for {{ species['name'] }}----------
profile
{
    py_mod = "py-script-{{ dims }}d", ! Name of Python file
    py_func = "set_density_{{ species['name'] }}", ! Name of function in the Python file to call
}

!----------boundary conditions for {{ species['name'] }}----------
spe_bound
{
    {% if dims == 1 %}type(1:2,1) = "thermal","thermal",
    uth_bnd(1:3,1,1) = {{ species['vth_start'] }}, {{ species['vth_start'] }}, {{ species['vth_start'] }}, 
    uth_bnd(1:3,2,1) = {{ species['vth_end'] }}, {{ species['vth_end'] }}, {{ species['vth_end'] }},{% else %}
    type(1:2,1) = "thermal","thermal",
    type(1:2,2) = "thermal","thermal",
    uth_bnd(1:3,1,1) = {{ species['vth_x_start'] }}, {{ species['vth_x_start'] }}, {{ species['vth_x_start'] }}, 
    uth_bnd(1:3,2,1) = {{ species['vth_x_end'] }}, {{ species['vth_x_end'] }}, {{ species['vth_x_end'] }}, 
    uth_bnd(1:3,1,2) = {{ species['vth_y_start'] }}, {{ species['vth_y_start'] }}, {{ species['vth_y_start'] }}, 
    uth_bnd(1:3,2,2) = {{ species['vth_y_end'] }}, {{ species['vth_y_end'] }}, {{ species['vth_y_end']}}, {% endif %}
}

!----------diagnostic for {{ species.name }}----------
diag_species
{
    ndump_fac = 1,
    ndump_fac_temp = 1,
    ndump_fac_ene = 1,
    reports = "charge", "j1", "j2", "j3", "q1", "q2", "q3",
    rep_udist = "uth1", "uth2", "ufl1", "ufl2",
    ndump_fac_pha = 1,
    ps_pmin(1:3) = {{ ps_pmin[0] }}, {{ ps_pmin[1] }}, {{ ps_pmin[2] }},
    ps_pmax(1:3) = {{ ps_pmax[0] }},  {{ ps_pmax[1] }},  {{ ps_pmax[2] }},
    {% if dims == 1 %}ps_xmin(1:1) = 0.0,
    ps_xmax(1:1) = {{ xmax }},{% else %}
    ps_xmin(1:{{ dims }}) = {{ xmin }}, {{ ymin }},
    ps_xmax(1:{{ dims }}) = {{ xmax }}, {{ ymax }},{% endif %}
    ps_np = {{ ps_np[0] }}, {{ ps_np[1] }}, {{ ps_np[2] }},
    {% if dims == 1 %}
    ps_nx = {{ ps_nx }},
    phasespaces = "p1x1", "p2x1", "p3x1",
    {% else %}
    ps_nx(1:{{ dims }}) = {{ ps_nx }}, {{ ps_ny }},
    phasespaces = "p1x1", "p2x1", "p3x1", "p1x2", "p2x2", "p3x2",
    {% endif %}
}
{% endfor %}

!--------Current smoothing----------
smooth
{
  type(1:{{ dims }}) = "{{ smooth_type }}",
  order(1:{{ dims }}) = {{ smooth_order }},
}

!---------- end of osiris input file -------------